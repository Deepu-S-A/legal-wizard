<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="../assets/css/basic.css">
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/owl.theme.default.min.css">
  <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.css" rel="stylesheet">
  <!-- fonts -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="icon" href="../assets/img/favicon.png" type="image/gif" sizes="16x16">
  <title>Wizard</title>
  <style>
    header {top: 0}
    span.input-wrap {background: rgb(74, 248, 89);}
    span.input-wrap.active {background: rgb(248, 244, 29);}
    .mappingConfigWrap {background: #fff;}
    .overlay,.overlay2{
      width: 100%;
      height: 100%;
      position: absolute;
      z-index: 1;
      opacity: 0.5;
      cursor: not-allowed;
      background: #fff;
    }
    .overlay {display: none;width: 96%;}
    .scroll-section {
      height: 500px;
      overflow-y: scroll;
      border-radius: 0;
    }
    .overlay2 {height: 29.5rem;}
    .tab-pane {padding-top: 1rem;min-height: 16rem;}
    ul#pills-tab {
      background: #fff;
      border-bottom: 0;
      padding-top: 1rem;
    }
    div#pills-tabContent {
      border-top: 0;
      background: #fff;
      overflow: hidden;
    }
    .row.container-wrap {
    min-height: 38rem;
}
div#pills-dynamic {
    min-height: 27rem;
}
    .txt-style {padding: 0 2rem;margin-bottom: 1rem;}
    span.blur-document {opacity: 0.4;}
    .btn-style1 {padding: 5px 1.1rem;}
    .removeDynamicOption{border-radius: 1.1rem;height: 28px;line-height: 0px;position: absolute;right: 6px;top: -14px;}
    .static-configurations-wrap{min-height:43rem;}
    .option-wrap{padding: 1rem;border: 1px solid #ccc;padding-bottom: 0;position: relative;}
    .dynamic-options-wrap{max-height: 350px;overflow-y: auto;}
    .doc-container-lhs-wrap{position: relative;}
    .floating-buttons-wrap{position: absolute;top:1rem;right:3rem;z-index: 999;}
    #dynamic-fields-config-wrap{display: none;}
    .df-steps.step2{display: none;}
    .dynamic-field-section {background: #e9c686;}
    #preview-container #header,.hidden-in-preview{display: none;}
    #preview-container .view-container{padding-top: 0;}
    #questionDropdown-wrap{max-height: 150px;overflow-y:auto;max-width: 100%;}
    iframe#preview-container {
    width: 100%;
    height: 35rem;
}
.sample-document {padding: 6% 0%;}
a.dropdown-item.docCategoryDdn {
    cursor: pointer;
}
#editDocument-container{height: 500px;}

  </style>
</head>

<body>
  <div class="spinner">
      <img class="spinner-img" alt="loading" src="../assets/img/spinner.gif"/>
  </div>
  <div id="header" class="section" w3-include-html="components/header.html"></div>
  <section class="sample-document inner-banner sample-document-2" id="content-container">
    <div class="container">
      <ul class="nav nav-tabs" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
          <a class="nav-link active" id="pills-upload-tab" data-toggle="pill" href="#pills-upload" role="tab"
            aria-controls="pills-upload" aria-selected="true">Select Document</a>
        </li>
        <li class="nav-item" role="presentation">
          <a class="nav-link" id="pills-questions-tab" data-toggle="pill"
            href="#pills-questions" role="tab" aria-controls="pills-questions" aria-selected="false">Add Questions</a>
        </li>
        <li class="nav-item" role="presentation">
          <a class="nav-link" id="pills-edit-tab" data-toggle="pill" href="#pills-edit" role="tab"
            aria-controls="pills-edit" aria-selected="false" onclick="renderEditQuestionsTable()">Edit Questions</a>
        </li>
        <!--<li class="nav-item" role="presentation">
          <a class="nav-link" id="pills-upload-thumbnail-tab" data-toggle="pill" href="#pills-upload-thumbnail" role="tab"
            aria-controls="pills-upload-thumbnail" aria-selected="false">Upload Thumbnail</a>
        </li>-->
        <li class="nav-item" role="presentation">
          <a class="nav-link" id="pills-summary-tab" data-toggle="pill" href="#pills-summary" role="tab"
            aria-controls="pills-summary" aria-selected="false">Create Summary Page</a>
        </li>
        <li class="nav-item" role="presentation">
          <a class="nav-link" id="pills-preview-tab" data-toggle="pill" href="#pills-preview" role="tab"
            aria-controls="pills-preview" aria-selected="false" onclick="renderPreview()">Preview</a>
        </li>
        <li class="nav-item" role="presentation">
          <a class="nav-link" id="pills-editDocument-tab" data-toggle="pill" href="#pills-renderEditDocument" role="tab"
            aria-controls="pills-renderEditDocument" aria-selected="false" onclick="renderEditDocument()">Edit Document</a>
        </li>
      </ul>
      <div class="tab-content" id="pills-tabContent">
        <div class="tab-pane fade show active pl-4" id="pills-upload" role="tabpanel"
          aria-labelledby="pills-upload-tab">
          <div class="form-group">
            <label for="categoryListDropdownWrap">Select Document Category</label>
            <div class="dropdown" id="categoryListDropdownWrap">
              <button class="btn btn-secondary dropdown-toggle btn-sm" type="button" id="catergorySelected" data-toggle="dropdown" aria-expanded="false">
                Select category
              </button>
              <div class="dropdown-menu" id="categoryList" aria-labelledby="catergorySelected">
                <a class="dropdown-item docCategoryDdn" href="javascript:void(0)">Category</a>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label for="categoryListDropdownWrap">Select Document Sub Category</label>
            <div class="dropdown" id="subCategoryListDropdownWrap">
              <button class="btn btn-secondary dropdown-toggle btn-sm" type="button" id="subCatergorySelected" data-toggle="dropdown" aria-expanded="false">
                Select sub category
              </button>
              <div class="dropdown-menu" id="subCategoryList" aria-labelledby="subCategoryListDropdownWrap">
                <a class="dropdown-item docSubCategoryDdn" href="javascript:void(0)">Sub category</a>
              </div>
            </div>
          </div>
          <form>

            <div class="form-group">
              <label for="doc_file">Select the Document to be uploaded</label>
              <input type="file" class="form-control-file" id="doc_file">
            </div>
          </form>
          <hr  class="mt-4 mb-4">
          <div class="mt-4 mb-4 txt-style1">
            Or Select an existing document
          </div>
          <div class="dropdowns-wrap">
            <div class="form-group">
              <table class="table table-hover table-bordered">
                <thead>
                  <tr>
                    <th scope="col">#</th>
                    <th scope="col">Document Name</th>
                    <th scope="col">last Modified</th>
                    <th scope="col">Action</th>
                  </tr>
                </thead>
                <tbody id="documentsList">
                  <tr>
                    <td>
                    <td>Please select a category to load documents</td>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="pills-questions" role="tabpanel" aria-labelledby="pills-questions-tab">
          <div class="row container-wrap">
            <div class="col-md-8 col-sm-12 lhs-wrap doc-container-lhs-wrap">
              <div class="overlay"></div>
              <div class="scroll-section scrollable-element" id="docContainer">
              </div>
              <div class="floating-buttons-wrap">
                <button class="btn btn-dark btn-sm" type="button" onclick="undoSelection()">Undo Input Selection</button>
                <button class="btn btn-primary btn-sm ml-2" id="blurDocumentBtn" onclick="blurDocument()" type="button">Blur</button>
                <button class="btn btn-danger btn-sm ml-2 mr-4" type="button" onclick="removeBlur()">Remove Blur</button>
                  <button class="completedQuestionConfig btn-style1 ml-4" id="completedQuestionConfig" type="button">Finish & Save To Server</button>
              </div>
            </div>
            <div class="col-md-4 col-sm-12 pl-0 mappingConfigWrap" id="mappingConfigWrap">

              <ul class="nav nav-tabs" id="questionsType-tab" role="tablist">
                <li class="nav-item" role="presentation">
                  <a class="nav-link active" id="pills-normal-tab" data-toggle="tab" href="#pills-normal" role="tab" aria-controls="pills-normal" aria-selected="true" onclick="resetDyamicSettings()">Normal Questions</a>
                </li>
                <li class="nav-item" role="presentation">
                  <a class="nav-link" id="pills-dynamic-tab" onclick="undoSelection()" data-toggle="tab" href="#pills-dynamic" role="tab" aria-controls="pills-dynamic" aria-selected="false">Dynamic Content</a>
                </li>
              </ul>
              <div class="tab-content" id="pills-questionsType-tabContent">
                <div class="tab-pane fade show active" id="pills-normal" role="tabpanel" aria-labelledby="pills-normal-tab">
                  <div class="static-configurations-wrap w-100 pl-4 pr-4" id="static-configurations-wrap">
                    <div class="overlay2"></div>
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                      <li class="nav-item" role="presentation">
                        <a class="nav-link active" id="addNew-tab" data-toggle="tab" href="#addNew" role="tab"
                          aria-controls="addNew" aria-selected="true">New Question</a>
                      </li>
                      <li class="nav-item" role="presentation">
                        <a class="nav-link" id="selectExisting-tab" data-toggle="tab" href="#selectExisting" role="tab"
                          aria-controls="selectExisting" aria-selected="false">Choose Existing</a>
                      </li>
                    </ul>
                    <div class="tab-content" id="myTabContent">
                      <div class="tab-pane fade show active pl-2 pr-2" id="addNew" role="tabpanel" aria-labelledby="addNew-tab">
                        <div class="form-group">
                          <textarea class="form-control rounded-0" placeholder="Please enter the question for the selected input" id="questionText" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                          <div class="form-control" id="questionDesc"></div>
                        </div>
                        <div class="form-group">
                          <input type="text" placeholder="Enter a sample answer (Optional)" class="form-control rounded-0" id="sampleAnswer"/>
                        </div>
                        <textarea class="form-control rounded-0 mt-2 mb-3" placeholder="Enter the message for alert notifocation (Optional)" id="alertText" rows="2"></textarea>
                        <div class="dropdown inputTypeDropdown">
                          <button class="btn btn-info btn-sm dropdown-toggle" type="button" id="inputTypeDropdown"
                            data-toggle="dropdown" aria-expanded="false">
                            Answer Type
                          </button>
                          <div class="dropdown-menu" aria-labelledby="inputTypeDropdown">
                            <button class="dropdown-item" type="button">Text</button>
                            <button class="dropdown-item" type="button">Number</button>
                            <button class="dropdown-item" type="button">Date</button>
                            <button class="dropdown-item" type="button">Amount</button>
                            <button class="dropdown-item" type="button">Textarea</button>
                          </div>
                        </div>
                      </div>
                      <div class="tab-pane fade" id="selectExisting" role="tabpanel" aria-labelledby="selectExisting-tab">
                        <div class="dropdown questionDropdown-section">
                          <button class="btn btn-info btn-sm dropdown-toggle" type="button" id="questionDropdown"
                            data-toggle="dropdown" aria-expanded="false">
                            Select question
                          </button>
                          <div class="dropdown-menu" id="questionDropdown-wrap" aria-labelledby="questionDropdown">
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="tab-pane fade" id="pills-dynamic" role="tabpanel" aria-labelledby="pills-dynamic-tab">
                  <div class="d-flex">
                    <div class="form-check ml-4">
                      <input class="form-check-input" type="radio" name="dynamicQuestionType" id="dynamicQuestionTypeText" onchange="dynamicOptionChange(this)" value="text" checked>
                      <label class="form-check-label" for="dynamicQuestionTypeText">
                        Text
                      </label>
                    </div>
                    <div class="form-check ml-4">
                      <input class="form-check-input" type="radio" name="dynamicQuestionType" id="dynamicQuestionTypeFields" onchange="dynamicOptionChange(this)" value="fields">
                      <label class="form-check-label" for="dynamicQuestionTypeFields">
                        Fields
                      </label>
                    </div>
                  </div>

                  <div class="dynamic-configurations-wrap w-100" id="dynamic-configurations-wrap">
                    <div class="dynamic-config-wrap">
                      <div class="dynamic-options-wrap pl-1 pr-1" id="dynamic-text-config-wrap">
                        <div class="form-group mt-1">
                          <textarea placeholder="Enter question for the selection" class="form-control rounded-0" id="dynamicQuestionText" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                          <div id="dynamicQuestionDesc"></div>
                        </div>
                        <textarea class="form-control rounded-0 mt-2 mb-3" placeholder="Enter the message for alert notifocation (Optional)" id="alertTextforDynamicText" rows="2"></textarea>
                        <div class="label-txt mb-4">Enter Option name and corresponding Text</div>
                        <div class="option-wrap">
                          <div class="form-group">
                            <input type="text" placeholder="Enter Option Name" class="form-control dynamicOption">
                          </div>
                          <div class="form-group">
                            <textarea placeholder="Enter Text for this option" class="form-control rounded-0 dynamicContentText" rows="2"></textarea>
                          </div>
                        </div>
                        <div class="d-options-group"></div>
                        <div class="btnwrap mt-2 mb-4">
                          <button class="btn btn-secondary btn-sm" onclick="addNewDynamicOption()" type="button">Add option</button>
                          <button class="btn btn-primary btn-sm ml-3" onclick="saveDynamicConfig()" type="button">Save Question</button>
                        </div>
                      </div>
                      <div id="dynamic-fields-config-wrap">
                        <div id="dynamic-fields-instructions">
                          <div class="df-steps step1 mt-4 text-center">
                            <textarea class="form-control rounded-0 mt-2 mb-3" placeholder="Enter the message for alert notifocation (Optional)" id="alertTextforDynamicFields" rows="2"></textarea>
                            <button class="btn btn-success btn-sm" onclick="wrapDynamicFiledsPortion()">After selecting the portion, click here</button>
                          </div>
                          <div class="df-steps step2 mt-4">
                            <div class="label-txt">Double click on the dynamic field in the doc and enter the question</div>
                            <div class="form-group mt-3">
                              <textarea placeholder="Enter question for the selected field" class="form-control rounded-0" id="df-question" rows="2"></textarea>
                            </div>
                            <div class="form-group mt-2">
                              <textarea placeholder="Enter description for this question" class="form-control rounded-0" id="df-desc" rows="2"></textarea>
                            </div>
                            <button class="btn btn-success btn-sm" onclick="addDynamicFieldQuestion()">Add question for this field</button>
                          </div>
                        </div>
                        <div class="btnwrap mt-2 mt-4">
                          <button class="btn btn-primary btn-sm ml-3" onclick="saveDynamicFieldConfig()" type="button">Save Question</button>
                        </div>
                      </div>

                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
        <div class="tab-pane fade pl-4" id="pills-edit" role="tabpanel" aria-labelledby="pills-edit-tab">
          <table class="table table-hover table-bordered">
            <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">Question</th>
                <th scope="col">Type</th>
                <th scope="col">Action</th>
              </tr>
            </thead>
            <tbody id="questionsTable">
            </tbody>
          </table>
          <div class="d-flex btns-wrap">
            <button class="completedQuestionConfig ml-4 btn-style1" type="button">Finish & Save To Server</button>
          </div>
        </div>
        <div class="tab-pane fade pl-4" id="pills-summary" role="tabpanel" aria-labelledby="pills-summary-tab">
          <div id="summary-container" class="scroll-section">

          </div>
          <button class="completedQuestionConfig btn-style1 ml-4 mt-4" id="completedQuestionConfig" type="button">Finish & Save To Server</button>
        </div>
        <div class="tab-pane fade pl-4" id="pills-preview" role="tabpanel" aria-labelledby="pills-preview-tab">
          <div class="preview-info mb-4" id="preview-info"></div>
          <iframe id="preview-container" src="" style="overflow-y: hidden;"></iframe>
          <button class="completedQuestionConfig btn-style1" id="completedQuestionConfig" type="button">Finish & Save To Server</button>
        </div>
        <div class="tab-pane fade pl-4" id="pills-renderEditDocument" role="tabpanel" aria-labelledby="pills-renderEditDocument-tab">
          <div id="editDocument-container" class="scroll-section">

          </div>
          <button class="btn-green btn-style1 ml-4 mt-4" data-toggle="modal" data-target="#confirmationModal" type="button">Save Changes</button>
        </div>
      </div>
  </section>
  <div class="modal fade" id="draftNotification" tabindex="-1" aria-labelledby="draftNotificationLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="draftNotificationLabel">Load Existing Draft</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="txt">We already have a saved configuration for this document.</div>
        </div>
        <div class="modal-footer">
          <button type="button" onclick="loadExistingDraft()" class="btn btn-secondary" data-dismiss="modal">Modify Existing Draft</button>
          <button type="button" class="btn btn-primary ml-4" data-dismiss="modal">New Configuration</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModelLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmationModelLabel">Modify Document</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="txt">This will modify the existing document. <br/> Please Ensure that your changes are not affecting the existing configured questions.</div>
        </div>
        <div class="modal-footer">
          <button type="button" onclick="saveChangesToTheDocument()" class="btn btn-primary" data-dismiss="modal">Modify document</button>
          <button type="button" class="btn btn-secondary ml-4" data-dismiss="modal" onclick="undoDocumentEdit()">Undo changes</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="finalConfirmationModal" tabindex="-1" aria-labelledby="finalConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content pr-4 pl-4">
        <div class="modal-header">
          <h5 class="modal-title" id="finalConfirmationModalLabel">Finish and save to server</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body pt-4 pb-4 mt-4 mb-4">
          <div class="txt">This will save all the configurations in to the server.</div>
        <br/>
        <div class="form-group form-check">
          <input type="checkbox" class="form-check-input" id="eSignatureEnabled">
          <label class="form-check-label" for="eSignatureEnabled">Check this box if this document is e-signature enabled</label>
        </div>
        </div>
        <div class="modal-footer">
          <button type="button" onclick="saveAllConfigurationsToServer()" class="btn btn-primary" data-dismiss="modal">Save all configurations</button>
          <button type="button" class="btn btn-secondary ml-4" data-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.js"></script>
  <script>
    let questionsList = [], inputCounter = -1,questionIndex=-1;
    let isConfigTypeStatic=true,docId=-1,selectedCategoryId=0;
    let dynamicContentSelection="",summaryPageContent="",selection = "";
    let dynamicOptionCounter=0,dynamicSectionCounter=0,dynamicFieldCounter=0;
    let dynamicFieldQuestion={
      questionId: 0,fieldQuestions:[], alertText:"",dynamicType:"fields",inputType: "text",
      dynamicContent:true,anwered:false,question: "",desc:"", isSavingCompleted:false,section:''
    };
    const baseUrl="http://ezyhostings-001-site1.dtempurl.com/api/DocManagement";
    docUpload = (url,file)=> {
      const categoryId=$("#catergorySelected").attr("data-categoryId");
        $(".spinner").show()
        let formData = new FormData();
        formData.append("docFile", file);
        let randomNumber=Math.random();
        formData.append("documentNo", randomNumber);
        formData.append("documentName", file.name);
        formData.append("categoryID",categoryId)
        $.ajax({
          type: "post",
          contentType:'application/json',
          data: formData,
          url: url,
          cache: false, contentType: false, processData: false, timeout: 60000,
          success: function (response) {
            docId=response.data.documentID;
            fetchDocFromServer(response.data.documentID)
          },
          error: function (error) {
            alert("File Upload Failed !!!!");$(".spinner").hide();
          }
        });
    }
    fetchDocFromServer = (documentID) => {
      $('#summary-container').summernote('code',' ');
      $("#dynamicQuestionDesc").summernote('code'," ");
      $("#questionDesc").summernote('code'," ");
      questionsList.length=0;
      inputCounter=-1,dynamicOptionCounter=0,dynamicFieldCounter=-1;
      dynamicSectionCounter=-1,questionIndex=-1;
      $('#docContainer').html("");
      $("#dynamicQuestionText").val('');
      $("#alertTextForDynamicText").val('');
      $(".dynamicOption").val('');
      $(".dynamicContentText").val('');
      $(".additionaly-added-options").remove();
      $("#df-question").val('');
      $("#df-desc").val('');
      $("#alertTextForDynamicFields").val('');
      $(".input-wrap").removeClass("active");
      $("#questionDropdown-wrap").html("");
      $("#eSignatureEnabled").prop('checked', false);
      resetDynamicFields();
      resetConfigBox();
      docId=documentID;
      const Url = baseUrl+"/GetDocumentByDocumentID/"+documentID;
      $.ajax({
        url: Url,
        type: 'GET',
        success: function (resposnse) {
          $('#docContainer').html(resposnse.data.htmlString);
          $("#pills-questions-tab").trigger("click");
          $(".spinner").hide();
          fetchDraft();
        }, error: function (err) { alert(err);$(".spinner").hide() }
      });
    }

    let temp;
    fetchDraft=()=>{
      const Url = baseUrl+"/DocumentMappingByDocumentID/"+docId;
      $.ajax({
        url: Url,
        type: 'GET',
        success: function (response) {
          if(response.data){
            temp=response.data;
            $("#draftNotification").modal('show')
          }
        }, error: function (err) { alert(err);$(".spinner").hide() },
        complete:function(){$(".spinner").hide();}
      });
    }

    loadExistingDraft=()=>{
      localStorage.setItem("docConfig",JSON.stringify(temp))
      const mappingJson=JSON.parse(temp.mappingJson);
      $("#docContainer").html(mappingJson.docAsHtml);
      $('#summary-container').summernote('code',mappingJson.summaryPage)
      questionsList=mappingJson.questionsList;
      inputCounter=temp.inputCounter;
      dynamicFieldCounter=temp.dynamicFieldCounter;
      dynamicSectionCounter=temp.dynamicSectionCounter;
      questionIndex=temp.questionIndex;
      const val = temp.eSignatureEnabled ? temp.eSignatureEnabled : false;
      $("#eSignatureEnabled").prop('checked', val);
      renderSavedQuestionsList();
      console.log("Loading new doc ======================>")
      console.log(mappingJson);
    }
    renderPreview=()=>{
      let docConfig={
        documentID :docId,
        documentMappingID:0,
        mappingJson:JSON.stringify({
          questionsList:questionsList,
          docAsHtml:$('#docContainer').html(),
          summaryPage:$('#summary-container').summernote('code')
        })
      }
      localStorage.setItem("docConfig",JSON.stringify(docConfig))
      $("#preview-container").attr("src",'document-create.html?mode=preview');
    }

    saveDynamicConfig=()=>{
      let question = $("#dynamicQuestionText").val();
      let alertText = $("#alertTextForDynamicText").val();
      if(question){
        let span = document.createElement('span');
        span.className = 'dq-text-wrap dqt'+(++dynamicSectionCounter);
        if(wrapDocument(span) && $("#docContainer").find('.dqt'+dynamicSectionCounter).length>0){
          let  options=[],valid=true;
          $(".option-wrap").each(function(i){
            let option=$(this).find('input').val();
            let text=$(this).find('textarea').val();
            if(option!="" && text!=""){
              options.push({name:option,text:text,subQuestions:[]})
            }else{ valid=false;alert("Please Enter the value in all fields");return false;}
          })
          if(valid){
            let desc=$("#dynamicQuestionDesc").summernote('code');
            switch(options.length){
              case 1:inputType="checkbox";break;
              case 2:inputType="radio";break;
              default:inputType="select";break;
            }
            questionsList.push({
              questionId: ++questionIndex,alertText:alertText, dynamicType:"text", inputType: inputType,dynamicContent:true,anwered:false,answer:"",
              question: question,desc:desc, options:options, section:'dqt'+dynamicSectionCounter
            });
            $(".dqt"+dynamicSectionCounter).attr("data-dqt-ref",questionIndex);
            console.log(questionsList);
            let i=-1,html="";
            for(let item of options){
              html+=`<span class="dt dt${++i}" data-optionIndex="${i}">${item.text}</span>`;
            }
            $(".dqt"+dynamicSectionCounter).html(html);
            $("#dynamicQuestionText").val('');
            $("#alertTextForDynamicText").val('');
            $('#dynamicQuestionDesc').summernote('code', '');
            $(".dynamicOption").val('');
            $(".dynamicContentText").val('');
            $(".additionaly-added-options").remove();
            alert("Done Dynamic question is configured !");
            $("#pills-normal-tab").trigger("click");
            return true;
          }else{alert("Please fill all the fields");}
        }else{ alert("Please select the section that needs to be dynamic !");$('.dynamic-section'+dynamicSectionCounter).remove();--dynamicSectionCounter}
      }else alert("Plese enter the question and other fields !");
      return false
    }
    deleteQuestion=(index)=>{
      let question=questionsList[index];
      if(question.dynamicContent){
        if(question.dynamicType=="text"){
          $("."+question.section).removeClass('dqt'+question.section);
        }else{
          $("."+question.section).removeClass('dynamic-field-section '+question.section);
        }
      }
      questionsList.splice(index,1);
      renderEditQuestionsTable();
      renderSavedQuestionsList();
      alert("Question is deleted !")
    }
    resetDyamicSettings=()=>{
      if(dynamicFieldQuestion.section!=""){
        $("."+dynamicFieldQuestion.section).removeClass(dynamicFieldQuestion.section);
        --dynamicFieldCounter;
        resetDynamicFields();
      }
      $(".overlay2").show();
    }
    resetDynamicFields=()=>{
      dynamicFieldQuestion.fieldQuestions.length=0;
      dynamicFieldQuestion.question="";
      dynamicFieldQuestion.desc="";
      dynamicFieldQuestion.alertText="";
      dynamicFieldQuestion.section="";
      dynamicOptionCounter=0;
      $(".df-steps.step2").hide();
      $(".df-steps.step1").show();
    }
    wrapDynamicFiledsPortion=()=>{
      let div = document.createElement('div');
      div.className = 'dynamic-field-section dynamic-field'+(++dynamicFieldCounter);
      wrapDocument(div);
      dynamicFieldQuestion.section='dynamic-field'+dynamicFieldCounter;
      $(".df-steps.step1").hide();
      $(".df-steps.step2").show();
    }
    addDynamicFieldQuestion=()=>{
      if(selection!=""){
        const question = $("#df-question").val();
        const desc = $("#df-desc").val();
        let alertText = $("#alertTextForDynamicFields").val();
        dynamicFieldQuestion.fieldQuestions.push({question:question,answer:"",desc:desc,field:".input" +inputCounter})
        $("#df-question").val('');
        $("#df-desc").val('');
        $("#alertTextForDynamicFields").val('');
        $(".input-wrap").removeClass("active")
        $(".overlay").hide(); selection = "";
      }else alert("Please select the field")
    }
    saveDynamicFieldConfig=()=>{
      let alertText = $("#alertTextForDynamicFields").val();
        questionsList.push({
            questionId: ++questionIndex,alertText:alertText,fieldQuestions:[...dynamicFieldQuestion.fieldQuestions], dynamicType:"fields",inputType: "text",dynamicContent:true,anwered:false,
            question: "",desc:"", section:dynamicFieldQuestion.section
        });
        alert("Question added successfully !");
        resetDynamicFields();
        $("#pills-normal-tab").trigger("click");
        console.log(questionsList);
    }
    dynamicOptionChange=(radioBtn)=>{
      if(radioBtn.value=="fields"){
        $("#dynamic-text-config-wrap").hide();
        $("#dynamic-fields-config-wrap").show();
      } else{
        $("#dynamic-fields-config-wrap").hide();
        $("#dynamic-text-config-wrap").show();
        if(dynamicFieldQuestion.section!=""){
          $("."+dynamicFieldQuestion.section).removeClass(dynamicFieldQuestion.section);
          --dynamicFieldCounter;
          resetDynamicFields();
        }
      }
    }
    addNewDynamicOption=()=>{
      ++dynamicOptionCounter;
      let html=`<div class="option-wrap additionaly-added-options option-wrap`+dynamicOptionCounter+`">
                  <button class="btn btn-danger removeDynamicOption btn-sm float-right mb-1" data-rel="option-wrap`+dynamicOptionCounter+`" type="button">X</button>
                  <div class="form-group"><input type="text" placeholder="Enter Option Name" class="form-control" id="dynamicOption`+dynamicOptionCounter+`"></div>
                  <div class="form-group"><textarea class="form-control rounded-0" placeholder="Enter Text for this option" id="dynamicContentText`+dynamicOptionCounter+`" rows="2"></textarea></div>
                </div>`;
      $(".d-options-group").append(html);
    }
    saveQuestion = () => {
      let type = $("#inputTypeDropdown").html();
      let question = $("#questionText").val();
      let descr = $('#questionDesc').summernote('code');
      let alertText = $('#alertText').val();
      let parent=$(".input"+inputCounter).closest(".dq-text-wrap");
      if(parent.length==0){
        questionsList.push({
          questionId: ++questionIndex,alertText:alertText,sampleAnswer:$("#sampleAnswer").val(),inputType: type,dynamicContent:false,answered:false,answer:"",
          question: question, desc:descr, inputs: [".input" +inputCounter]
        });
        $("#questionDropdown-wrap").append('<button data-ref="' + questionIndex + '" class="dropdown-item question-ddl" type="button">' + question + '</button>');
      }else{
        const qid=$(parent).attr("data-dqt-ref");
        let questionObj=questionsList.find(q=>q.questionId==qid);
        const optionIndex=parseInt($(".input"+inputCounter).closest(".dt").attr("data-optionIndex"));
        questionObj.options[optionIndex].subQuestions.push({
          questionId: ++questionIndex,optionIndex:optionIndex,sampleAnswer:$("#sampleAnswer").val(),inputType: type,dynamicContent:false,answered:false,answer:"",
          question: question, desc:descr, inputs: [".input" +inputCounter]
        });
        console.log("Subquestion added !");
        console.log(questionObj);
      }
      this.resetConfigBox();
    }
    bindEvents = () => {
      $(document).on("click", ".removeDynamicOption", function () {$("."+$(this).attr("data-rel")).remove();});
      $(document).on("click", ".removeDynamicOption", function () {$("."+$(this).attr("data-rel")).remove();});
      $(".inputTypeDropdown").find(".dropdown-item").click(function () {
        if ($("#questionText").val() == "") alert("Please enter the question");
        else {
          $("#inputTypeDropdown").html($(this).html());saveQuestion()
        }
      })
      $(document).on("click", ".question-ddl", function () {
        let questionId = parseInt($(this).attr("data-ref"))
        questionsList[questionId].inputs.push(".input" + inputCounter)
        resetConfigBox();
      })
      document.getElementById("docContainer").addEventListener('dblclick', function (e) {
        selection = window.getSelection().toString();
        let style = window.getSelection().anchorNode.parentElement.classList[0];
        if (selection.indexOf("_") > -1 && style != "input-wrap") {
          let span = document.createElement('span');
          span.className = 'input-wrap active input' + (++inputCounter);
          span.style.marginRight = "5px";
          wrapDocument(span);
          $(".overlay").show(); $(".overlay2").hide();
        }
      });
      $("#doc_file").on("change", function (e) {
        const categoryId=$("#catergorySelected").attr("data-categoryId");
        if(categoryId){
          let file = $(this)[0].files[0];
          //let upload = new Upload(file);
          const url=baseUrl+'/SaveAndUploadDocument';
          docUpload(url,file);
        }else{alert("Please Select the Category !");$(this).val('')}
      });
      $("#img_file").on("change", function (e) {
        let file = $(this)[0].files[0];
        const url=baseUrl+'/SaveAndUploadDocument';
        docUpload(url,file);
      });
      $(".completedQuestionConfig").click(function (e) {
        $("#finalConfirmationModal").modal("show");
      });
      $(document).on("click", ".docCategoryDdn", function () {
        selectedCategoryId=$(this).attr("data-categoryId");
        $("#catergorySelected").html($(this).html()).attr("data-categoryId",selectedCategoryId)
        renderDocumentsTable(selectedCategoryId);
      });
      $(document).on("click", ".documentBtn", function () {
        let docId=$(this).attr("data-docId")
        fetchDocFromServer(docId)
      });
      init();
    }

    saveAllConfigurationsToServer = () => {
      console.log($("#eSignatureEnabled").is(':checked'));
      let docConfig={
          documentID :docId,
          eSignatureEnabled: $("#eSignatureEnabled").is(':checked'),
          documentMappingID:0,
          inputCounter:inputCounter,
          dynamicFieldCounter:dynamicFieldCounter,
          dynamicSectionCounter:dynamicSectionCounter,
          questionIndex:questionIndex,
          mappingJson:JSON.stringify({
            questionsList:questionsList,
            docAsHtml:$('#docContainer').html(),
            summaryPage:$('#summary-container').summernote('code')
          })
        }
        $(".spinner").show()
        localStorage.setItem("docConfig",JSON.stringify(docConfig))
        $.ajax({
          url: baseUrl+'/SaveDocumentMapping',
          type: 'post',
          dataType: "json",
          contentType: "application/json",
          data:JSON.stringify(docConfig),
          success: function (resposnse) {
            alert("Saved Succesfully !");$(".spinner").hide();
            location.reload();
          },
          error: function (err) {
            alert("Error while saving data to DB");$(".spinner").hide();
            location.reload();
          }
        });
    }

    renderEditDocument=()=>{
      $("#editDocument-container").summernote('code', $('#docContainer').html());
    }
    saveChangesToTheDocument=()=>{
      $('#docContainer').html($("#editDocument-container").summernote('code'));
      $("#pills-questions-tab").trigger("click");
    }
    undoDocumentEdit = () => {
      $("#editDocument-container").summernote('code', '');
      $("#pills-questions-tab").trigger("click");
    }
    renderDocumentsTable=(categoryId)=>{
        let signatureHtml = `<img src="../assets/img/signature.png" class="signature" data-toggle="tooltip" data-placement="top" title="This document is esgnature enabled"/>`;
        $.ajax({
          url: baseUrl+'/GetDocumentDropDownData/'+categoryId,
          type: 'GET',
          complete:function(){$(".spinner").hide()},
          success: function (resposnse) {let html=`<tr>`,counter=0;
            for(let item of resposnse.data){
              item.tag = item.tag.split('.')[0];
              const dateModified=item.lastUpdatedDate!=null?item.lastUpdatedDate:"";
              let docName = item.eSignatureEnabled ? `${item.tag} ${signatureHtml}` : `${item.tag}`;
              html+=`<th scope="row">`+(++counter)+`</th><td class="dropdown-item">${docName} </td><td>${dateModified}</td>
              <td><button class="btn btn-primary btn-sm documentBtn" data-docId="${item.id}">Configure</button>
                <button class="btn btn-danger deleteDocument btn-sm ml-3" onclick="deleteDocument(${item.id})" data-docId="${item.id}">Delete</button></tr>`;
            }
            $("#documentsList").html(html);
            $('.signature').tooltip()
          }, error: function (err) { alert(err);$(".spinner").hide() }
        });
    }
    init=()=>{
      $('#editDocument-container').summernote({
        placeholder: 'Edit your document',
        tabsize: 2,
        height: 500,
        toolbar: [
          ['style', ['style']],
          ['font', ['bold', 'underline', 'clear']],
          ['color', ['color']],
          ['para', ['ul', 'ol', 'paragraph']],
          ['table', ['table']],
          ['insert', ['link', 'picture', 'video']],
          ['view', ['fullscreen', 'codeview', 'help']]
        ]
      });
      $('#summary-container').summernote({
        placeholder: 'Create the Document summary',
        tabsize: 2,
        height: 400,
        toolbar: [
          ['style', ['style']],
          ['font', ['bold', 'underline', 'clear']],
          ['color', ['color']],
          ['para', ['ul', 'ol', 'paragraph']],
          ['table', ['table']],
          ['insert', ['link', 'picture', 'video']],
          ['view', ['fullscreen', 'codeview', 'help']]
        ]
      });
      $('#questionDesc').summernote({
        placeholder: 'Enter Question Description',
        tabsize: 2,
        height: 60,
        toolbar: [
          ['style', ['style']],
          ['font', ['bold', 'underline', 'clear']],
          ['color', ['color']],
          ['para', ['ol', 'paragraph']],
          ['insert', ['link']],
          ['view', ['fullscreen', 'codeview', 'help']]
        ]
      });
      $('#dynamicQuestionDesc').summernote({
        placeholder: 'Enter Question Description',
        tabsize: 2,
        height: 60,
        toolbar: [
          ['style', ['style']],
          ['font', ['bold', 'underline', 'clear']],
          ['color', ['color']],
          ['para', ['ol', 'paragraph']],
          ['insert', ['link']],
          ['view', ['fullscreen', 'codeview', 'help']]
        ]
      });
      renderCategoryList()
    }
    deleteDocument=(docId)=>{
      $(".spinner").show()
      const url=baseUrl+'/DeleteDocument/'+docId;
      $.ajax({
        url: url,
        type: 'DELETE',
        complete:function(){$(".spinner").hide()},
        success: function (resposnse) {let html='';
          alert("Document has been deleted !");
          renderDocumentsTable(selectedCategoryId);
        }, error: function (err) { alert(err);$(".spinner").hide() }
      });

    }
    renderCategoryList=()=>{
      $(".spinner").show()
      $.ajax({
        url: 'http://ezyhostings-001-site1.dtempurl.com/api/Master/GetAllCategorys',
        type: 'GET',
        complete:function(){$(".spinner").hide()},
        success: function (resposnse) {let html='';
          for(let item of resposnse.data){
            html+=`<a class="dropdown-item docCategoryDdn" data-categoryId=${item.categoryID}>${item.categoryName}</a>`;
          }
          $("#categoryList").html(html)
        }, error: function (err) { alert(err);$(".spinner").hide() }
      });
    }
    undoSelection=()=>{
      if(selection!=""){
        $(".input"+inputCounter).removeClass("input-wrap active input"+inputCounter);
        --inputCounter;
        $(".overlay").hide(); $(".overlay2").show(); selection = "";
      }
    }
    resetConfigBox = () => {
      $("#inputTypeDropdown").html("Answer Type");$("#sampleAnswer").val("");
      $("#questionText").val("");
      $('#questionDesc').summernote('code','');
      $(".input-wrap").removeClass("active");
      $('#alertText').val("");
      $(".overlay").hide(); $(".overlay2").show(); selection = "";
      console.log(questionsList)
    }
    document.addEventListener("DOMContentLoaded", bindEvents);
    blurDocument = () => {
      let span = document.createElement('span');span.className = 'blur-document';
      span.style.opacity="0.2";
      wrapDocument(span)
    }
    wrapDocument=(span)=>{
      let sel, range;
      if (window.getSelection) {
        sel = window.getSelection();
        if (sel.rangeCount) {
          range = sel.getRangeAt(0);span.appendChild(range.extractContents());
          range.insertNode(span);sel.removeAllRanges();
          if (document.selection) document.selection.empty();
          return true;
        }else{ alert("Please select the area in the document !"); return false;}
      }return false
    }
    removeBlur = () => {$('.blur-document').css('opacity',1).removeClass('blur-document')}
    renderEditQuestionsTable = () => {
      let tr = "", i = -1;
      for (let question of questionsList) {
        if(question.dynamicContent==true&&question.dynamicType=="fields"){
          tr += `<tr><th scope="row">` + (++i) + `</th>
            <td class="questionCol">Dynamic Field question</td>
            <td>`+ question.inputType + `</td>
            <td>  <button class="btn btn-danger ml-2" onclick="deleteQuestion(${i})" type="button">Delete</button>
            </td>
          </tr>`;
        }else{
          tr += `<tr><th scope="row">` + (++i) + `</th>
            <td class="questionCol"><input type="text" class="questionTxt${i}" value="` + question.question + `"/></td>
            <td>`+ question.inputType + `</td>
            <td><button class="btn btn-primary editRowBtn" onclick="editQuestion(${i})" type="button">Edit</button>
              <button class="btn btn-danger ml-2" onclick="deleteQuestion(${i})" type="button">Delete</button>
            </td>
          </tr>`;
        }
      }
      $("#questionsTable").html(tr)
    }
    editQuestion = (index) => {
      questionsList[index].question = $(".questionTxt" + index).val();
      renderSavedQuestionsList();
      alert("Details are updated !");
    }
    backToAddQuestions=()=>{
      $("#pills-questions-tab").trigger("click");
    }
    renderSavedQuestionsList = () => {
      let list = '', i = -1;
      for (let question of questionsList){
        if(!question.dynamicContent)
          list += `<button data-ref="${question.questionId}" class="dropdown-item question-ddl" type="button">${question.question}</button>`;
      }
      $("#questionDropdown-wrap").html(list)
    }
    includeHTML=()=> {
      let z, i, elmnt, file, xhttp;
      z = document.getElementsByClassName("section");
      for (i = 0; i < z.length; i++) {
        elmnt = z[i];
        file = elmnt.getAttribute("w3-include-html");
        if (file) {
          xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function () {
            if (this.readyState == 4) {
              if (this.status == 200) { elmnt.innerHTML = this.responseText; }
              if (this.status == 404) { elmnt.innerHTML = "Page not found."; }
              elmnt.removeAttribute("w3-include-html");
              includeHTML();
            }
          }
          xhttp.open("GET", file, true);
          xhttp.send();
          return;
        }
      }
    }
    includeHTML()
  </script>
</body>
</html>